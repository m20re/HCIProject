{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Twilingo â€” Map</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="icon" href="data:,">
  {% if countriesData %}
    {{ countriesData|json_script:"countries-data" }}
  {% endif %}
  <style>
    #map { height: 420px; width: 100%; }
  </style>
</head>
<body>
<header class="header">
  <div class="header-inner">
    <nav>
      <a href="/">Home</a>
      <a href="/about">About</a>
    </nav>
  </div>
</header>

<main class="main stack">
  <section class="card pad stack">
    <h1 class="h1 m-0">Translate Anything</h1>
    <p class="lead">Step 1) Choose languages</p>
    <p class="lead">Step 2) Click on "Start Translating".</p>
    <p class="lead">Step 3) Click on "Stop" when you are ready. (You have a limit of 45 seconds)</p>

    <!-- Language controls -->
    <div class="controls">
      <div class="lang-picker">
        <label class="lang-label" for="fromLang">From</label>
        <select id="fromLang" class="select">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
        </select>
      </div>

      <button class="swap-btn" id="swapLangs" title="Swap languages">â‡„</button>

      <div class="lang-picker">
        <label class="lang-label" for="toLang">To</label>
        <select id="toLang" class="select">
          <option value="es">Spanish</option>
          <option value="en">English</option>
          <option value="fr">French</option>
          <option value="de">German</option>
        </select>
      </div>
    </div>

    <!-- Text areas -->
    <label class="label">Your speech (source)</label>
    <div id="transcriptText" class="textarea" style="min-height:4rem;"></div>

    <label class="label" style="margin-top:.75rem;">Translation (target)</label>
    <div id="translatedText" class="textarea" style="min-height:4rem;"></div>

    <div class="actions">
      <button class="btn btn-primary" id="translateBtn">
        <i class="fa-solid fa-play"></i> Start Translating
      </button>
      <button class="btn btn-ghost" id="stopBtn">Stop</button>
      <button class="btn btn-ghost" id="clearTextarea">Clear</button>
      <p id="status" class="lead" style="margin-top:.5rem">Ready</p>
    </div>
  </section>

  <!-- Map -->
  <section class="card pad">
    <h2 class="h2 m-0">Map</h2>
    <div id="map"></div>
  </section>
</main>

<script>
window.API = {
  uploadAudioUrl: "{% url 'upload_audio' %}",
  translateAudioUrl: "{% url 'translate_audio' %}"
};
</script>
<script src="{% static 'translator/translator.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const recBtn = document.getElementById("translateBtn");
  const stopBtn = document.getElementById("stopBtn");

  // automatically click "Start Translating" after 1s
  setTimeout(() => recBtn.click(), 1000);

  // automatically stop recording after 7 seconds (adjust as needed)
  setTimeout(() => stopBtn.click(), 8000);
});

// ðŸ”Š Automatically play translated audio when translation completes
// Hook into global event from translator.js (it calls show(data))
window.addEventListener("translationComplete", (e) => {
  const data = e.detail;
  if (data && data.audio_url) {
    try {
      const audio = new Audio(data.audio_url);
      audio.play()
        .then(() => console.log("Playing translated audio automatically"))
        .catch(err => console.warn("Audio playback failed:", err));

      const translatedText = document.getElementById("translatedText");
      translatedText.innerHTML += `
        <br><br><strong>Translated Audio:</strong><br>
        <audio controls src="${data.audio_url}" style="width:100%;max-width:400px;"></audio>
      `;
    } catch (err) {
      console.error("Error initializing translated audio:", err);
    }
  }
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const map = L.map('map').setView([0, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Load all countries from the local JSON file and display them on the map
    fetch("{% static 'ui/countryLang.json' %}")
      .then(res => res.json())
      .then(data => {
        window.countries = data || [];

        window.countries.forEach(c => {
          let lat = c.lat ?? c.latitude;
          let lon = c.lon ?? c.longitude ?? c.lng;

          // Convert string coordinates to numbers if needed
          if (typeof lat === 'string') lat = parseFloat(lat);
          if (typeof lon === 'string') lon = parseFloat(lon);

          if (typeof lat !== 'number' || typeof lon !== 'number' || isNaN(lat) || isNaN(lon)) return;

          // Build languages text
          let langsText = '';

          if (Array.isArray(c.languages)) {
            langsText = c.languages
              .map(l => (typeof l === 'string' ? l : (l.name || l.code || '')))
              .filter(Boolean)
              .join(', ');
          } else if (typeof c.languages === 'string') {
            langsText = c.languages;
          } else if (c.languages && typeof c.languages === 'object') {
            langsText = Object.values(c.languages)
              .filter(v => typeof v === 'string' && v.trim().length > 0)
              .join(', ');
          } else if (typeof c.language === 'string') {
            langsText = c.language;
          } else if (typeof c.lang === 'string') {
            langsText = c.lang;
          } else if (typeof c.Language === 'string') {
            langsText = c.Language;
          }

          const countryName = c.name || c.country || 'Unknown country';
          const popupText = `
            <strong>${countryName}</strong><br>
            ${langsText ? `Language(s): ${langsText}` : 'Language(s): N/A'}
          `;

          L.marker([lat, lon]).addTo(map).bindPopup(popupText);
        });
      })
      .catch(err => {
        console.error("Error loading countryLang.json:", err);
      });

    // Try to locate the user and show "You are here" + nearest country/language
    map.locate({ setView: true, maxZoom: 8 });

    map.on('locationfound', (e) => {
      const countries = window.countries || [];

      const userLat = e.latlng.lat;
      const userLon = e.latlng.lng;

      let closestCountry = null;
      let closestDist = Infinity;

      countries.forEach(c => {
        let lat = c.lat ?? c.latitude;
        let lon = c.lon ?? c.longitude ?? c.lng;

        // Convert string coordinates to numbers if needed
        if (typeof lat === 'string') lat = parseFloat(lat);
        if (typeof lon === 'string') lon = parseFloat(lon);

        if (typeof lat !== 'number' || typeof lon !== 'number' || isNaN(lat) || isNaN(lon)) return;

        const dLat = lat - userLat;
        const dLon = lon - userLon;
        const distSq = dLat * dLat + dLon * dLon;

        if (distSq < closestDist) {
          closestDist = distSq;
          closestCountry = c;
        }
      });

      console.log('Closest country detected:', closestCountry);

      let langsText = '';

      if (closestCountry) {
        if (Array.isArray(closestCountry.languages)) {
          langsText = closestCountry.languages
            .map(l => (typeof l === 'string' ? l : (l.name || l.code || '')))
            .filter(Boolean)
            .join(', ');
        } else if (typeof closestCountry.languages === 'string') {
          langsText = closestCountry.languages;
        } else if (closestCountry.languages && typeof closestCountry.languages === 'object') {
          langsText = Object.values(closestCountry.languages)
            .filter(v => typeof v === 'string' && v.trim().length > 0)
            .join(', ');
        } else if (typeof closestCountry.language === 'string') {
          langsText = closestCountry.language;
        } else if (typeof closestCountry.lang === 'string') {
          langsText = closestCountry.lang;
        } else if (typeof closestCountry.Language === 'string') {
          langsText = closestCountry.Language;
        }
      }

      const popupText = langsText && langsText.trim().length > 0
        ? `You are here!<br>Language(s): ${langsText}`
        : 'You are here!';

      L.marker(e.latlng).addTo(map).bindPopup(popupText).openPopup();
    });
  });
</script>
</body>
</html>
