{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Twilingo — Map</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="icon" href="data:,">
  {% if countriesData %}
    {{ countriesData|json_script:"countries-data" }}
  {% endif %}
  <style>
    /* Fallback to ensure map is visible even if external CSS fails */
    #map { height: 420px; width: 100%; }
  </style>
</head>
<body>
<header class="header">
  <div class="header-inner">
    <!-- <div class="brand">
      <span class="brand-badge"></span>
      Twilingo
    </div> -->
    <nav>
      <a href="/">Home</a>
      <a href="/about">About</a>
    </nav>
  </div>
</header>

<main class="main stack">
  <section class="card pad stack">
    <h1 class="h1 m-0">Translate Anything</h1>
    <p class="lead">Choose languages, type your text, and translate.</p>

    <!-- Language controls -->
    <div class="controls">
      <div class="lang-picker">
        <label class="lang-label" for="fromLang">From</label>
        <select id="fromLang" class="select">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <!-- add more -->
        </select>
      </div>

      <button class="swap-btn" id="swapLangs" title="Swap languages">⇄</button>

      <div class="lang-picker">
        <label class="lang-label" for="toLang">To</label>
        <select id="toLang" class="select">
          <option value="es">Spanish</option>
          <option value="en">English</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <!-- add more -->
        </select>
      </div>
    </div>

    <!-- Text areas -->
    <div class="textareas">
      <textarea class="input" id="sourceText" placeholder="Type or paste text here..."></textarea>
      <div class="output" id="translatedText">Your translation will appear here…</div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" id="translateBtn">Translate</button>
      <button class="btn btn-ghost" id="clearTextarea">Clear</button>
      <button class="btn btn-ghost" id="copyBtn">Copy</button>
    </div>
  </section>

  <!-- Map card (if you’re showing a map) -->
  <section class="card pad">
    <h2 class="h2 m-0">Map</h2>
    <div id="map"></div>
  </section>
</main>

<script>
  // swap selected languages
  const swap = document.getElementById('swapLangs');
  const fromSel = document.getElementById('fromLang');
  const toSel = document.getElementById('toLang');

  swap?.addEventListener('click', () => {
    const temp = fromSel.value;
    fromSel.value = toSel.value;
    toSel.value = temp;
  });

  // map setup
  document.addEventListener('DOMContentLoaded', () => {
    const mapEl = document.getElementById('map');
    if (!mapEl) return;

    const map = L.map('map').setView([0, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // get current location
    map.locate({ setView: true, maxZoom: 16 });

    map.on('locationfound', (e) => {
      L.marker(e.latlng)
        .addTo(map)
        .bindPopup('You are here!')
        .openPopup();
    });

    map.on('locationerror', () => {
      alert("Couldn't get your location, showing default view.");
      map.setView([41.2565, -95.9345], 12);
    });

    // Read countries data safely from json_script (if present)
    const countries = (() => {
      const el = document.getElementById('countries-data');
      if (!el) return [];
      try {
        return JSON.parse(el.textContent);
      } catch (err) {
        console.error('Invalid countriesData JSON:', err);
        return [];
      }
    })();

    // Add markers for each country
    countries.forEach(country => {
      const lat = country.lat ?? country.latitude;
      const lon = country.lon ?? country.longitude ?? country.lng;
      if (typeof lat !== 'number' || typeof lon !== 'number') return;

      // languages can be ["en","es"] or [{name:"English"}, ...]
      const langs = Array.isArray(country.languages)
        ? country.languages.map(l => (typeof l === 'string' ? l : (l.name || l.code || ''))).filter(Boolean).join(', ')
        : '';

      const iso = country.iso2 || country.iso || '';
      const popupContent = `
        <strong>${country.name || 'Unknown'}${iso ? ` (${iso})` : ''}</strong><br>
        ${langs ? `Languages: ${langs}` : ''}
      `;

      L.marker([lat, lon]).addTo(map).bindPopup(popupContent.trim());
    });


    // Clear button logic
    const clearBtn = document.getElementById('clearTextarea');
    const sourceText = document.getElementById('sourceText');
    const translatedText = document.getElementById('translatedText');

    clearBtn?.addEventListener('click', () => {
      sourceText.value = '';
      translatedText.textContent = 'Your translation will appear here…';
    });


    // fix sizing if layout loads late
    setTimeout(() => map.invalidateSize(), 300);
  });


</script>

</body>
</html>